# Apache VirtualHost configuration with mod_auth_mellon for SAML authentication
# This should be saved as httpd.conf in the apache-mellon directory

# Global Mellon configuration (must be outside VirtualHost)
MellonCacheSize 100
MellonLockFile "/run/mod_auth_mellon/lock"

# Set up the SAML endpoints (global configuration)
MellonSPPrivateKeyFile /etc/mellon/sp-private-key.pem
MellonSPCertFile /etc/mellon/sp-certificate.pem
MellonSPMetadataFile /etc/mellon/sp-metadata.xml
MellonIdPMetadataFile /etc/mellon/idp-metadata.xml

# University of Michigan specific settings
MellonVariable "saml-name-id"
MellonMergeEnvVars on

# SAML endpoints
MellonEndpointPath /mellon

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName pssid-metrics.miserver.it.umich.edu
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

# HTTPS Virtual Host with SAML Authentication
<VirtualHost *:443>
    ServerName pssid-metrics.miserver.it.umich.edu
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/pssid-metrics.miserver.it.umich.edu/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/pssid-metrics.miserver.it.umich.edu/privkey.pem
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    
    # Protect the entire site with SAML
    <Location />
        MellonEnable "auth"
        AuthType "Mellon"
        Require valid-user
        
        # Require specific group membership
        # Adjust the attribute name and value based on what U-M provides
        # You may need to comment this out initially for testing
        # Require mellon-attribute "eduperson_ismemberof" "groupa@group.edu"
    </Location>
    
    # Don't protect the SAML endpoints
    <Location /mellon>
        MellonEnable "info"
        Require all granted
    </Location>
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Set headers from SAML attributes for Grafana
    # Map SAML attributes to headers Grafana expects
    RequestHeader set X-WEBAUTH-USER %{MELLON_uid}e
    RequestHeader set X-WEBAUTH-NAME %{MELLON_displayName}e
    RequestHeader set X-WEBAUTH-EMAIL %{MELLON_mail}e
    RequestHeader set X-WEBAUTH-GROUPS %{MELLON_eduperson_ismemberof}e
    
    # Alternative if U-M uses different attribute names (uncomment to test)
    # RequestHeader set X-WEBAUTH-USER %{MELLON_eppn}e
    # RequestHeader set X-WEBAUTH-NAME %{MELLON_cn}e
    
    # Proxy all requests to Grafana (except SAML endpoints)
    ProxyPass /mellon !
    ProxyPass / http://grafana:3000/
    ProxyPassReverse / http://grafana:3000/
    
    # Log configuration
    ErrorLog ${APACHE_LOG_DIR}/ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/ssl_access.log combined
    
    # Log SAML attributes for debugging
    LogFormat "%t %{MELLON_uid}e %{MELLON_displayName}e %{MELLON_mail}e %{MELLON_eduperson_ismemberof}e" mellon
    CustomLog ${APACHE_LOG_DIR}/mellon_access.log mellon
</VirtualHost>